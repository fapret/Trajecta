<html lang="es">
<head>
  <title>Subjects Graph</title>
  <script
          type="text/javascript"
          src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"
  ></script>
  <style type="text/css">
    #mynetwork {
      width: 2000px;
      height: 1000px;
      border: 1px solid lightgray;
    }
  </style>
</head>
<body>
<div id="mynetwork">
  <form id="plan_ucs">
    <input id="faculty" placeholder="Faculty" name="faculty" type="text" />
    <input id="career" placeholder="Career" name="career" type="text" />
    <input id="plan" placeholder="Plan" name="plan" type="text" />
    <button type="submit">Send</button>
  </form>
</div>
</body>
</html>
<script>
  function findKeyByValue(obj, value) {
    for (let key in obj) {
      if (obj[key]['materia_id'] === value) {
        return obj[key]['id']; // Return the key if the value is found
      }
    }
    return null; // Return null if the value is not found
  }

  // Add an event listener to the form submit event
  document.getElementById('plan_ucs').addEventListener('submit', function (event) {
    event.preventDefault(); // Prevent the default form submission
    const facultyName = document.getElementById("faculty").value;
    const careerName = document.getElementById("career").value;
    const planYear = document.getElementById("plan").value;
    const url = `http://localhost:8080/curricula_microservice/Faculty/Carrera/Plan/ucs?faculty=${facultyName}&career=${careerName}&plan=${planYear}`;

    var nodos = [];
    var nodos_0 = [];
    var nodos_process = {};
    var nodos_final = [];
    var aristas = [];

    fetch(url)
            .then(response => response.json())
            .then(materias => {

              // Make an AJAX request to the server
              var formData = new FormData(this);
              // Copia de los datos del formulario para la segunda solicitud
              var formDataCopy = new FormData(document.getElementById('plan_ucs'));

              const facultyName = document.getElementById("faculty").value;

              for (let i = 0; i < materias.length; i++) {
                nodos_0.push({id: i + 1, materia_id: materias[i]});
              }

              for (let i = 0; i < materias.length; i++) {
                let apiUrl = `http://localhost:8080/curricula_microservice/Faculty/ucs?faculty=${facultyName}&curricularUnit=` + materias[i];
                fetch(apiUrl)
                        .then(response => {
                          if (!response.ok) {
                            throw new Error('No se pudo obtener la respuesta de la API');
                          }
                          return response.json(); // Parsear la respuesta JSON
                        })
                        .then(async data => {
                          const result = await getMaxRequirementLevel(facultyName, materias[i]);
                          nodos.push({
                            id: i + 1,
                            materia_id: materias[i],
                            materia_name: data['Name'],
                            level: result,
                            label: data['Name'],
                            shape: "box",
                            color: "#F28C28",
                            font: {color: "white"}
                          });
                          nodos_process[materias[i]] = null;

                          if ((data.Requirement).length > 0) {
                            //PENDIENTE: si es un someof, tengo que ver cuales de las N se cumple,
                            //y mostrar solo las aristas de ella. por ejemplo, tprog y sus 2 vias de cursado
                            if (Object.keys(data.Requirement[0])[0] === "SomeOf") {
                              for (let j = 1; j < (data.Requirement[0]['SomeOf']).length; j++) {
                                let a = data.Requirement[0]['SomeOf'][j];
                                let b = Object.keys(a);
                                let req = b[0];
                                if (req === "Coursed") {
                                  let source_index = findKeyByValue(nodos_0, a['Coursed']);
                                  let dest_index = findKeyByValue(nodos_0, materias[i]);
                                  let aaa = {
                                    from: source_index,
                                    to: dest_index,
                                    color: "#0000FF",
                                    arrows: "to",
                                    dashes: true
                                  };
                                  aristas.push(aaa);
                                } else if (req === "Exam") {
                                  let source_index = findKeyByValue(nodos_0, a['Exam']);
                                  let dest_index = findKeyByValue(nodos_0, materias[i]);
                                  let aaa = {
                                    from: source_index,
                                    to: dest_index,
                                    color: "#0000FF",
                                    arrows: "to"
                                  };
                                  aristas.push(aaa);
                                }
                              }
                            } else {
                              let a = data.Requirement[0];
                              let b = Object.keys(a);
                              let req = b[0];
                              if (req === "Coursed") {
                                let source_index = findKeyByValue(nodos_0, a['Coursed']);
                                let dest_index = findKeyByValue(nodos_0, materias[i]);
                                let aaa = {
                                  from: source_index,
                                  to: dest_index,
                                  color: "#0000FF",
                                  arrows: "to",
                                  dashes: true
                                };
                                aristas.push(aaa);
                              } else if (req === "Exam") {
                                let source_index = findKeyByValue(nodos_0, a['Exam']);
                                let dest_index = findKeyByValue(nodos_0, materias[i]);
                                let aaa = {
                                  from: source_index,
                                  to: dest_index,
                                  color: "#0000FF",
                                  arrows: "to"
                                };
                                aristas.push(aaa);
                              }
                            }
                          }
                          let nodos_dt = new vis.DataSet(nodos);
                          let aristas_dt = new vis.DataSet(aristas);
                          var container = document.getElementById("mynetwork");

                          var data2 = {
                            nodes: nodos_dt,
                            edges: aristas_dt,
                          };
                          directionInput = "DU";
                          var options = {
                            edges: {
                              smooth: {
                                type: "cubicBezier",
                                forceDirection: "horizontal",
                                roundness: 0.4,
                              },
                            },
                            layout: {
                              hierarchical: {
                                direction: directionInput,
                                sortMethod: 'directed',
                                nodeSpacing: 200, //separacion horizontal
                                levelSeparation: 150, // separacion vertical
                              },
                            },
                            physics: false,
                          };
                          var network = new vis.Network(container, data2, options);
                        })

                        .catch(error => {
                          console.error('Error:', error);
                        });
              }

            });
  });

async function getMaxRequirementLevel(facultyName, cu_id) {
  let apiUrl = `http://localhost:8080/curricula_microservice/Faculty/ucs?faculty=${facultyName}&curricularUnit=${cu_id}`;

  try {
    const response = await fetch(apiUrl);

    if (!response.ok) {
      throw new Error('No se pudo obtener la respuesta de la API');
    }

    const data = await response.json();

    if (data['Requirement'].length === 0)
      if (data['Id'] === "P1") // porque P1 se dicta en el segundo semestre
        return 1;
      else
        return 0;
    else {
      const req_values = [];

      for (let i = 0; i < data['Requirement'].length; i++) {
        const subRequirement = data['Requirement'][i];

        if (subRequirement.Exam) {
          req_values.push(await getMaxRequirementLevel(facultyName, subRequirement.Exam));
        } else if (subRequirement.Coursed) {
          req_values.push(await getMaxRequirementLevel(facultyName, subRequirement.Coursed));
        }
        else if (subRequirement.SomeOf) {
          for (let j = 0; j < subRequirement.SomeOf.length; j++) {
            if (subRequirement.SomeOf[j].Exam)
              req_values.push(await getMaxRequirementLevel(facultyName, subRequirement.SomeOf[j].Exam));
            else if (subRequirement.SomeOf[j].Coursed)
              req_values.push(await getMaxRequirementLevel(facultyName, subRequirement.SomeOf[j].Coursed));

          }
        }
      }
      let base = 1;
      if (data['Id'] === "P4" || data['Id'] === "LOGICA" || data["Id"] === "METNUM" || data["Id"] === "FBD" || data["Id"] === "PROLOG" || data["Id"] === "PROGFUN" || data["Id"] === "IIO")
        base = 2;

      return base + Math.max(...req_values);
    }
  } catch (error) {
    console.error(error);
    return 0;
  }
}
</script>
